/****************************************************
  FanController - Captive Config (Dark Purple Theme)
  Board: ESP32
  Config fields: SSID, Password, Blynk Auth Token, Blynk Template ID, Device Name
  - Auto attempt saved WiFi (15s)
  - If fail: open AP FanSetup_XXXX and captive portal
  - Save to Preferences and reboot to apply
****************************************************/

// --- placeholders required by Blynk library at compile time ---
#define BLYNK_TEMPLATE_ID   "PLACEHOLDER_TEMPLATE_ID"
#define BLYNK_TEMPLATE_NAME "PLACEHOLDER_TEMPLATE_NAME"
#define BLYNK_AUTH_TOKEN    "PLACEHOLDER_AUTH_TOKEN"

// --- includes ---
#include <WiFi.h>
#include <WebServer.h>
#include <DNSServer.h>
#include <Preferences.h>
#include <BlynkSimpleEsp32.h>

// --- pins ---
#define RELAY1 18
#define RELAY2 25
#define RELAY3 26
#define BUTTON_PIN 19

// --- Preferences keys ---
Preferences prefs;
const char* PREF_NS = "fancfg";
const char* KEY_SSID    = "wifi_ssid";
const char* KEY_PASS    = "wifi_pass";
const char* KEY_BLYNK   = "blynk_token";
const char* KEY_TMPLID  = "tmpl_id";
const char* KEY_TMPLNM  = "tmpl_name";
const char* KEY_DEVNAME = "dev_name";

// --- captive portal and webserver ---
WebServer server(80);
DNSServer dnsServer;
const byte DNS_PORT = 53;
IPAddress apIP(192,168,4,1);
String apName;
bool portalActive = false;
unsigned long portalStart = 0;
const unsigned long PORTAL_TIMEOUT = 180000; // 3 minutes

// --- runtime state ---
String savedSSID = "", savedPASS = "", savedBlynkToken = "";
String savedTmplID = "", savedTmplName = "", savedDevName = "";
bool mainSwitch = false;
int currentMode = 0;

BlynkTimer timer;
bool blynkConnected = false;

// --- Virtual pins (same as your original) ---
#define VPIN_MAIN_SWITCH V0
#define VPIN_MODE_SELECT V5
#define VPIN_TERMINAL   V10
#define RELAY_ON  LOW
#define RELAY_OFF HIGH

// --- widget ---
WidgetTerminal terminal(VPIN_TERMINAL);

// terminal
void debugLog(String msg) {
  Serial.println(msg);
  terminal.println(msg);
  terminal.flush();
}

// --- HTML: Dark Purple / Modern ---
const char CONFIG_PAGE[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fan Setup</title>
<style>
  :root{--bg:#0b0710;--card:#0f0b16;--accent:#7b3cff;--muted:#9aa0b4;--glass:rgba(255,255,255,0.03)}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e6e9ef;background:linear-gradient(180deg,#07050b 0%, #0b0710 100%);-webkit-font-smoothing:antialiased;}
  .wrap{max-width:640px;margin:28px auto;padding:18px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(11,6,17,0.6)}
  h1{margin:0;font-size:20px;color:var(--accent);letter-spacing:0.2px}
  p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
  label{display:block;margin-top:12px;font-size:13px;color:#dfe6ff}
  input[type=text], input[type=password], select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:#fff;margin-top:6px;box-sizing:border-box;font-size:14px}
  button{width:100%;padding:12px;margin-top:16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#5f2bff);color:#fff;font-weight:700;font-size:15px;cursor:pointer;box-shadow:0 6px 18px rgba(123,60,255,0.18)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .ssid-item{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:6px;display:flex;justify-content:space-between;align-items:center}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:16px}
  @media (max-width:520px){.wrap{padding:12px}.card{padding:14px}}
</style>
</head>
<body>
 <div class="wrap">
  <div class="card">
    <h1>ตั้งค่าพัดลม (Fan Setup)</h1>
    <p class="lead">กรอกข้อมูล WiFi และ Blynk Token เพื่อให้พัดลมเชื่อมต่อและควบคุมผ่านแอป</p>
    
    <form method="POST" action="/save">
      <label for="ssid">WiFi SSID</label>
      <div class="row" style="align-items:center; margin-top:6px;">
        <div class="col">
          <select id="ssid_select" style="display:block;">
            <option value="">-- เลือกเครือข่าย --</option>
          </select>
          <input type="text" id="ssid_manual" name="ssid" placeholder="พิมพ์ SSID เอง" 
                style="display:none; margin-top:6px;">
        </div>
        <div style="margin-left:10px; white-space:nowrap;">
          <label style="display:flex; align-items:center; cursor:pointer; font-size:13px; color:var(--muted);">
            <input type="checkbox" id="ssid_manual_toggle" style="margin-right:6px;">
            แชร์จากเครื่องนี้
          </label>
        </div>
      </div>

      <label for="pass">WiFi Password</label>
      <div class="row" style="align-items:center; margin-top:6px; position:relative;">
        <div class="col">
          <input type="text" id="pass" name="pass" placeholder="รหัสผ่าน WiFi" value="{{WIFI_PASS}}" 
                style="padding-right:40px;">
        </div>
      </div>

    <div class="row" style="margin-top:16px; align-items:center;">
      <label style="display:flex; align-items:center; cursor:pointer; font-size:13px; color:var(--muted);">
        <input type="checkbox" id="blynk_edit_toggle" style="margin-right:6px;">
        แก้ไข Blynk Data
      </label>
    </div>

    <label for="blynk">Blynk Auth Token</label>
    <input type="password" id="blynk" name="blynk" placeholder="วาง Auth Token ของคุณที่นี่" value="{{BLYNK_TOKEN}}">

    <label for="tmplid">Blynk Template ID</label>
    <input type="password" id="tmplid" name="tmplid" placeholder="ตัวอย่าง: TMPLxxxxxxx" value="{{TMPL_ID}}">

    <label for="devname">Device / Template Name</label>
    <input type="password" id="devname" name="devname" placeholder="ชื่ออุปกรณ์ (เช่น FanLivingroom)" value="{{DEV_NAME}}">
      <button type="submit">บันทึกและรีสตาร์ท</button>
    </form>

    <div class="hint">หากหน้าเว็บไม่เด้งอัตโนมัติ ให้เปิดเบราเซอร์และเข้า <strong>http://192.168.4.1</strong></div>
    <div class="footer">FanController • พัดลมควบคุมด้วย Blynk</div>
    <div class="footer">จัดทำโดย 
    <br>นาย วภกฤษ รัดสิมวงษ์ 
    <br>นาย วรินทร นุชเสม</div>
  </div>
 </div>

<script>

  const selectBox = document.getElementById('ssid_select');
  const manualInput = document.getElementById('ssid_manual');
  const toggleChk = document.getElementById('ssid_manual_toggle');
  const form = document.querySelector('form');

  const savedSSID = "{{SAVED_SSID}}";

  // --- Blynk Edit Toggle ---
    const blynkFields = [
      document.getElementById('blynk'),
      document.getElementById('tmplid'),
      document.getElementById('devname')
    ];
    const blynkToggle = document.getElementById('blynk_edit_toggle');

    blynkToggle.addEventListener('change', function() {
      const isText = this.checked;
      blynkFields.forEach(field => {
        field.type = isText ? 'text' : 'password';
      });
    });
  function selectSavedSSID() {
    if (savedSSID && savedSSID.trim() !== "") {
      // ลองหาใน select ก่อน
      let found = false;
      for (let opt of selectBox.options) {
        if (opt.value === savedSSID) {
          opt.selected = true;
          found = true;
          break;
        }
      }

      if (!found) {
        toggleChk.checked = true;
        selectBox.style.display = 'none';
        manualInput.style.display = 'block';
        manualInput.value = savedSSID;
      }
    }
  }
  
  toggleChk.addEventListener('change', function() {
    if (this.checked) {
      selectBox.style.display = 'none';
      manualInput.style.display = 'block';
      manualInput.focus();
    } else {
      selectBox.style.display = 'block';
      manualInput.style.display = 'none';
      manualInput.value = '';
    }
  });

  form.addEventListener('submit', function(e) {
    if (!toggleChk.checked && selectBox.value) {
      manualInput.value = selectBox.value;
    }
  });

  fetch('/scan')
    .then(r => r.json())
    .then(list => {
      list.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n.ssid;
        opt.text = n.ssid + (n.sec ? ' (Secured)' : ' (Open)') + ' [' + n.rssi + 'dBm]';
        selectBox.appendChild(opt);
      });
      selectSavedSSID();
    })
    .catch(e => {
      console.log('scan error', e);
      if (savedSSID) {
        toggleChk.checked = true;
        selectBox.style.display = 'none';
        manualInput.style.display = 'block';
        manualInput.value = savedSSID;
      }
    });
</script>
</body>
</html>
)rawliteral";

// ----------------- helper functions -----------------
void setRelays(int mode) {
  if (!mainSwitch || mode == 0) {
    digitalWrite(RELAY1, RELAY_OFF);
    digitalWrite(RELAY2, RELAY_OFF);
    digitalWrite(RELAY3, RELAY_OFF);
    debugLog("Switch หลักปิดหรือ mode=0 → ปิดการใช้งานทั้งหมด");
    return;
  }

  switch (mode) {
    case 1:
      digitalWrite(RELAY1, RELAY_ON);
      digitalWrite(RELAY2, RELAY_OFF);
      digitalWrite(RELAY3, RELAY_OFF);
      break;
    case 2:
      digitalWrite(RELAY1, RELAY_ON);
      digitalWrite(RELAY2, RELAY_ON);
      digitalWrite(RELAY3, RELAY_OFF);
      break;
    case 3:
      digitalWrite(RELAY1, RELAY_ON);
      digitalWrite(RELAY2, RELAY_ON);
      digitalWrite(RELAY3, RELAY_ON);
      break;
    default:
      // ถ้า mode > 3 หรือผิดพลาด → ปิด
      digitalWrite(RELAY1, RELAY_OFF);
      digitalWrite(RELAY2, RELAY_OFF);
      digitalWrite(RELAY3, RELAY_OFF);
      break;
  }
}

void saveConfigAndRestart(const String& ssid, const String& pass, const String& blynk, const String& tmplid, const String& tmplname) {
  prefs.begin(PREF_NS, false);
  prefs.putString(KEY_SSID, ssid);
  prefs.putString(KEY_PASS, pass);
  prefs.putString(KEY_BLYNK, blynk);
  prefs.putString(KEY_TMPLID, tmplid);
  prefs.putString(KEY_TMPLNM, tmplname);
  prefs.end();

  debugLog("Saved new config. Rebooting...");
  delay(800);
  ESP.restart();
}

// ------------- web handlers -------------
void handleRoot() {
  String html = String(CONFIG_PAGE);

  prefs.begin(PREF_NS, true);
  String saved_ssid = prefs.getString(KEY_SSID, "");
  String pass = prefs.getString(KEY_PASS, "");
  String token = prefs.getString(KEY_BLYNK, "");
  String tmplid = prefs.getString(KEY_TMPLID, "");
  String devname = prefs.getString(KEY_DEVNAME, "");
  prefs.end();

  html.replace("{{SAVED_SSID}}", saved_ssid);
  html.replace("{{WIFI_PASS}}", pass);
  html.replace("{{BLYNK_TOKEN}}", token);
  html.replace("{{TMPL_ID}}", tmplid);
  html.replace("{{DEV_NAME}}", devname);

  server.sendHeader("Cache-Control", "no-cache, no-store, must-revalidate");
  server.sendHeader("Pragma", "no-cache");
  server.sendHeader("Expires", "-1");
  server.send(200, "text/html", html);
}

void handleScan() {
  int n = WiFi.scanNetworks();
  String json = "[";
  for (int i=0;i<n;i++) {
    String ss = WiFi.SSID(i);
    int rssi = WiFi.RSSI(i);
    bool secure = (WiFi.encryptionType(i) != WIFI_AUTH_OPEN);
    json += "{\"ssid\":\"" + ss + "\",\"rssi\":" + String(rssi) + ",\"sec\":" + String(secure ? "true":"false") + "}";
    if (i < n-1) json += ",";
  }
  json += "]";
  WiFi.scanDelete();
  server.send(200, "application/json", json);
}

void handleSave() {
  if (server.method() != HTTP_POST) {
    server.send(405, "text/plain", "Method Not Allowed");
    return;
  }
  String ssid = server.arg("ssid");
  String pass = server.arg("pass");
  String blynk = server.arg("blynk");
  String tmplid = server.arg("tmplid");
  String devname = server.arg("devname");

  Serial.printf("Config received: ssid=%s, pass_len=%d, token_len=%d, tmplid=%s, dev=%s\n",
                ssid.c_str(), pass.length(), blynk.length(), tmplid.c_str(), devname.c_str());

  if (ssid.length() == 0) {
    server.send(400, "text/plain", "SSID required");
    return;
  }

  // confirmation page
  String html = "<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>";
  html += "<title>Saving...</title><style>body{font-family:Arial;color:#fff;background:#0b0710;padding:30px;text-align:center} .box{display:inline-block;padding:18px;border-radius:10px;background:#120918} h2{color:#7b3cff}</style></head><body><div class='box'><h2>บันทึกค่าเรียบร้อย</h2><p>อุปกรณ์จะรีสตาร์ทและเชื่อมต่อ WiFi ใหม่ภายในไม่กี่วินาที</p></div></body></html>";
  server.send(200, "text/html", html);

  delay(600);
  saveConfigAndRestart(ssid, pass, blynk, tmplid, devname);
}

void handleNotFound(){
  // redirect unknown requests to captive portal
  server.sendHeader("Location", String("http://") + apIP.toString() + "/", true);
  server.send(302, "text/plain", "");
}

// ------------- captive portal start/stop -------------
void startCaptivePortal() {
  portalActive = true;
  portalStart = millis();

  // ดึง MAC Address หลังเปิด WiFi
  WiFi.mode(WIFI_AP);
  String macStr = WiFi.macAddress(); // ต้องหลัง WiFi.mode()
  String lastTwo = macStr.substring(12, 14) + macStr.substring(15, 17);
  lastTwo.toUpperCase();
  apName = "VBAC_FanSetup_BWR1";

  WiFi.softAPConfig(apIP, apIP, IPAddress(255,255,255,0));
  WiFi.softAP(apName.c_str());

  dnsServer.start(DNS_PORT, "*", apIP);

  server.on("/", handleRoot);
  server.on("/scan", handleScan);
  server.on("/save", HTTP_POST, handleSave);
  server.onNotFound(handleNotFound);
  server.begin();

  Serial.printf("Captive portal started: SSID=%s, IP=%s\n", apName.c_str(), apIP.toString().c_str());
}

void stopCaptivePortal() {
  server.stop();
  dnsServer.stop();
  WiFi.softAPdisconnect(true);
  portalActive = false;
  debugLog("Captive portal stopped.");
}

// ------------- setup & loop -------------
void setup() {
  Serial.begin(115200);
  delay(200);

  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  setRelays(0);

  // load prefs
  prefs.begin(PREF_NS, true);
  savedSSID = prefs.getString(KEY_SSID, "");
  savedPASS = prefs.getString(KEY_PASS, "");
  savedBlynkToken = prefs.getString(KEY_BLYNK, "");
  savedTmplID = prefs.getString(KEY_TMPLID, "");
  savedTmplName = prefs.getString(KEY_TMPLNM, "");
  savedDevName = prefs.getString(KEY_DEVNAME, "");
  prefs.end();

  Serial.print("Loaded config:");
  debugLog(String(" SSID: ") + savedSSID);
  Serial.print(" Blynk token: ");
  debugLog(savedBlynkToken.length() ? "<exists>" : "<none>");
  debugLog(" Template ID: " + savedTmplID);
  debugLog(" Template Name: " + savedTmplName);
  debugLog(" Device Name: " + savedDevName);

  // try connect to saved WiFi
  bool connected = false;
  if (savedSSID.length() > 0) {
    WiFi.mode(WIFI_STA);
    WiFi.begin(savedSSID.c_str(), savedPASS.c_str());
    debugLog("Connecting to saved WiFi...");
    unsigned long start = millis();
    while (millis() - start < 15000) {
      if (WiFi.status() == WL_CONNECTED) {
        connected = true;
        break;
      }
      delay(250);
      Serial.print(".");
    }
  }

  if (!connected) {
    debugLog("Failed to connect. Launching captive portal...");
    startCaptivePortal();
  } else {
    debugLog("Connected. IP: " + WiFi.localIP().toString());

    // apply template name & device name if saved (optional usage)
    if (savedTmplID.length() || savedTmplName.length()) {
      debugLog("Using saved template info.");
      // Note: these are stored for user and for possible server-side usage,
      // but Blynk library requires defines at compile time; runtime template values are for bookkeeping.
    }

    // start Blynk if token exists
    if (savedBlynkToken.length() > 0) {
      Blynk.config(savedBlynkToken.c_str());
      debugLog("Connecting to Blynk...");
      unsigned long st = millis();
      while (!Blynk.connected() && millis() - st < 5000) {
        Blynk.connect(500);
      }
      if (Blynk.connected()) {
        blynkConnected = true;
        debugLog("Blynk connected. Function Setup");
      } else {
        debugLog("Blynk connect failed (will retry in background).");
      }
    } else {
      debugLog("No Blynk token set; running local-only.");
    }
  }

  // timer tasks
  timer.setInterval(1000L, []() {
    if (portalActive) {
      if (millis() - portalStart > PORTAL_TIMEOUT) {
        debugLog("Portal timeout. Rebooting...");
        delay(600);
        ESP.restart();
      }
      dnsServer.processNextRequest();
    }
    if (Blynk.connected()) {
      Blynk.run();
    }
  });
}

void loop() {
  timer.run();
  if (portalActive) {
    dnsServer.processNextRequest();
    server.handleClient();
  } else {
    if (Blynk.connected()) Blynk.run();

    // local button fallback (if accessible externally)
    static unsigned long lastBtn = 0;
    if (digitalRead(BUTTON_PIN) == LOW && millis() - lastBtn > 300) {
      lastBtn = millis();
      mainSwitch = !mainSwitch;
      currentMode = mainSwitch ? 1 : 0;
      setRelays(currentMode);
      Serial.printf("Local button toggled -> mainSwitch=%d mode=%d\n", mainSwitch, currentMode);
      if (Blynk.connected()) {
        Blynk.virtualWrite(VPIN_MAIN_SWITCH, mainSwitch);
        Blynk.virtualWrite(VPIN_MODE_SELECT, currentMode);
      }
    }
  }
}

// --- Blynk handlers ---
// BLYNK_CONNECTED() {
//   debugLog("Blynk connected (callback).");
//   Blynk.syncAll();
// }

BLYNK_CONNECTED() {
  debugLog("Blynk connected. Syncing state...");
  Blynk.syncVirtual(VPIN_MAIN_SWITCH, VPIN_MODE_SELECT);

  // ส่งสถานะปัจจุบันทันที
  Blynk.virtualWrite(VPIN_MAIN_SWITCH, mainSwitch);
  Blynk.virtualWrite(VPIN_MODE_SELECT, mainSwitch ? currentMode : 0);
}

BLYNK_WRITE(VPIN_MAIN_SWITCH) {
  int v = param.asInt();
  mainSwitch = (v != 0);

  // ถ้าปิด บังคับ mode เป็น 0
  if (!mainSwitch) {
    currentMode = 0;
    Blynk.virtualWrite(VPIN_MODE_SELECT, 0);
  } else if (currentMode == 0) {
    // ถ้าเปิด แต่ mode ยังเป็น 0 ตั้งเป็น 1
    currentMode = 1;
    Blynk.virtualWrite(VPIN_MODE_SELECT, 1);
  }

  setRelays(currentMode);
  debugLog("Main Switch: " + String(mainSwitch ? "ON" : "OFF"));
}

BLYNK_WRITE(VPIN_MODE_SELECT) {
  int requestedMode = param.asInt();

  if (!mainSwitch) {
    // ถ้า mainSwitch ปิด บังคับส่ง mode 0 กลับ
    Blynk.virtualWrite(VPIN_MODE_SELECT, 0);
    currentMode = 0;
    setRelays(0);
    debugLog("Main Switch ปิดอยู่ → บังคับ Mode = 0");
    return;
  }

  // อนุญาตเฉพาะ 1,2,3
  if (requestedMode >= 1 && requestedMode <= 3) {
    currentMode = requestedMode;
  } else {
    currentMode = 1; // fallback
    Blynk.virtualWrite(VPIN_MODE_SELECT, 1);
  }

  setRelays(currentMode);
  debugLog("Mode ตั้งเป็น: " + String(currentMode));
}
